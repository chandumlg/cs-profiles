# Incremental SQL model for thena_tickets
# This model maintains the latest state of each ticket and supports rolling window queries
#
# NOTE: TICKET_ID was removed from PARTITION BY and SELECT columns because the column
# no longer exists in the upstream warehouse table. Deduplication is now solely by
# CHANNEL_NAME (one ticket per Slack channel). If the upstream schema ever reintroduces
# TICKET_ID, consider restoring it to PARTITION BY to support multiple tickets per channel.

models:
  - name: thena_tickets_history
    model_type: sql_template
    model_spec:
      occurred_at_col: CREATED_AT
      materialization:
        output_type: table
      single_sql: |
        {%- set lastThis = this.DeRef(pre_existing=true, dependency="optional", checkpoint_name="baseline") -%}

        {% set tickets_delta = this.DeRef("inputs/thena_tickets/incr_delta_tbl", dependency="coercive", baseline_name="baseline", prereqs=[lastThis]) %}

        {% set tickets_full = this.DeRef("inputs/thena_tickets", prereqs=[tickets_delta.Except()]) %}

        {# All DeRef before this line. #}

        {% if lastThis.IsEnabled() and tickets_delta.IsEnabled() %}
          -- Incremental mode: merge previous state with new ticket events
          -- Keep the most recent state for each ticket
          SELECT * FROM (
            WITH all_tickets AS (
              SELECT CHANNEL_NAME, STATUS, ESCALATION_TYPE, CREATED_AT, UPDATED_AT FROM {{ lastThis }}
              UNION ALL
              SELECT CHANNEL_NAME, STATUS, ESCALATION_TYPE, CREATED_AT, UPDATED_AT FROM {{ tickets_delta }}
            ),
            latest_tickets AS (
              SELECT
                CHANNEL_NAME,
                STATUS,
                ESCALATION_TYPE,
                CREATED_AT,
                UPDATED_AT,
                ROW_NUMBER() OVER (PARTITION BY CHANNEL_NAME
                                  ORDER BY CREATED_AT DESC) AS rn
              FROM all_tickets
            )
            SELECT
              CHANNEL_NAME,
              STATUS,
              ESCALATION_TYPE,
              CREATED_AT,
              UPDATED_AT
            FROM latest_tickets
            WHERE rn = 1
          )
        {% else %}
          -- Full refresh mode: process all tickets
          SELECT * FROM (
            WITH latest_tickets AS (
              SELECT
                CHANNEL_NAME,
                STATUS,
                ESCALATION_TYPE,
                CREATED_AT,
                UPDATED_AT,
                ROW_NUMBER() OVER (PARTITION BY CHANNEL_NAME
                                  ORDER BY CREATED_AT DESC) AS rn
              FROM {{ tickets_full }}
            )
            SELECT
              CHANNEL_NAME,
              STATUS,
              ESCALATION_TYPE,
              CREATED_AT,
              UPDATED_AT
            FROM latest_tickets
            WHERE rn = 1
          )
        {% endif %}
      contract:
        is_append_only: false
      ids:
        - select: CHANNEL_NAME
          type: slack_channel_name
          entity: account
