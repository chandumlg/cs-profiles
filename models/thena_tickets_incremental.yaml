# Incremental SQL model for thena_tickets
# This model maintains the latest state of each ticket and supports rolling window queries

models:
  - name: thena_tickets_history
    model_type: sql_template
    model_spec:
      occurred_at_col: CREATED_AT
      materialization:
        output_type: table
      single_sql: |
        {%- set lastThis = this.DeRef(
              pre_existing=true,
              dependency="optional",
              checkpoint_name="baseline") -%}

        {% set tickets_delta = this.DeRef("inputs/thena_tickets/incr_delta_tbl",
                                          dependency="coercive",
                                          baseline_name="baseline",
                                          prereqs=[lastThis]) %}

        {% set tickets_full = this.DeRef("inputs/thena_tickets",
                                         prereqs=[tickets_delta.Except()]) %}

        {# All DeRef before this line. #}

        {% if lastThis.IsEnabled() and tickets_delta.IsEnabled() %}
          -- Incremental mode: merge previous state with new ticket events
          -- Keep the most recent state for each ticket
          WITH all_tickets AS (
            SELECT * FROM {{ lastThis }}
            UNION ALL
            SELECT * FROM {{ tickets_delta }}
          ),
          latest_tickets AS (
            SELECT
              *,
              ROW_NUMBER() OVER (PARTITION BY CHANNEL_NAME, TICKET_ID
                                ORDER BY CREATED_AT DESC) AS rn
            FROM all_tickets
          )
          SELECT
            CHANNEL_NAME,
            TICKET_ID,
            STATUS,
            ESCALATION_TYPE,
            CREATED_AT,
            UPDATED_AT
          FROM latest_tickets
          WHERE rn = 1
        {% else %}
          -- Full refresh mode: process all tickets
          WITH latest_tickets AS (
            SELECT
              *,
              ROW_NUMBER() OVER (PARTITION BY CHANNEL_NAME, TICKET_ID
                                ORDER BY CREATED_AT DESC) AS rn
            FROM {{ tickets_full }}
          )
          SELECT
            CHANNEL_NAME,
            TICKET_ID,
            STATUS,
            ESCALATION_TYPE,
            CREATED_AT,
            UPDATED_AT
          FROM latest_tickets
          WHERE rn = 1
        {% endif %}
      contract:
        is_append_only: false
      ids:
        - select: CHANNEL_NAME
          type: slack_channel_name
          entity: account
